#!/usr/bin/octave -qf

#set (0, "defaultaxesfontname", "Arial") 
#set (0, "defaulttextfontname", "Arial")
#set (0, "defaultaxesfontname", "MingLiU") 
#set (0, "defaulttextfontname", "MingLiU")

arg_list = argv();
wavFile=[arg_list{1} ".wav"]
csvFile=[arg_list{1} "-sampling.csv"];
pngFile=[arg_list{1} ".png"];

[y,fs] = wavread(wavFile);
mono=y(:,1);

data = csvread(csvFile);
timestamp = data(:,1);
zcr = data(:,2);
variance = data(:,3);
rms = data(:,4);
ste = data(:,5);
pitch = data(:,6);
zcr_d = data(:,7);
var_d = data(:,8);
rms_d = data(:,9);
ste_d = data(:,10);

[status, m_param] = system(["iconv -f utf-16 -t utf-8 -c oto_ref.ini |grep ^" wavFile "|wc -l"]);

m_count = str2num(m_param);

[status, m_param] = system(["iconv -f utf-16 -t utf-8 -c oto_ref.ini |grep ^" wavFile "|awk -F, '{print $2\",\"$3\",\"$4\",\"$5\",\"$6}'"]);

[m_val, count, errmsg] = sscanf(m_param, "%d,%d,%d,%d,%d\n");

[status, m_param] = system(["iconv -f utf-16 -t utf-8 oto_ref.ini |grep ^" wavFile "|awk -F= '{print $2}'| awk -F, '{print $1}'|sed -e 's/ /_/g'|sed 's/.$//'|sed 's/^M$//' "]);

if (m_count == 0)
  m_count = 1;
  m_onn = "";
endif

for idx = 0 : m_count-1

[status, m_onn] = system(["iconv -f utf-16 -t utf-8 -c oto_ref.ini |grep ^" wavFile "|awk -F= '{print $2}'| sed 's/,.*$//g'|sed -e 's/ /_/g'|head -n" num2str(idx+1) "|tail -n 1"]);

m_onn = deblank(m_onn);

max_time = max(timestamp);
if( max_time > 2. )
  max_time = 2.;
endif

max_time = max_time*1.2;
min_time = 0.;

if(count >= 5)
  m_offs=m_val(idx*5+1)
  m_cons=m_val(idx*5+1)+m_val(idx*5+2)
  if(m_val(idx*5+3) < 0)
    m_vowl=m_val(idx*5+1)-m_val(idx*5+3)
  else
    m_vowl = length(mono)/fs*1000 - m_val(idx*5+3)
  endif
  m_prev=m_val(idx*5+1)+m_val(idx*5+4)
  m_olap=m_val(idx*5+1)-m_val(idx*5+5)

  m_offs=(m_val(idx*5+1))/1000;
  m_cons=(m_val(idx*5+1)+m_val(idx*5+2))/1000;
  if(m_val(idx*5+3) < 0)
    m_vowl=(m_val(idx*5+1)-m_val(idx*5+3))/1000;
  else
    m_vowl = length(mono)/fs - m_val(idx*5+3)/1000;
  endif
  m_prev=(m_val(idx*5+1)+m_val(idx*5+4))/1000;
  m_olap=(m_val(idx*5+1)-m_val(idx*5+5))/1000;

  max_time = m_vowl + (m_vowl-m_olap)*0.5;
  min_time = m_olap - (m_vowl-m_olap)*0.3;
endif

subplot(3,1,1);

hold ("on");
set (gca (), "xlim", [min_time, max_time]);
plot(( 1:length(mono)) /fs, mono );

m_tit = ["Waveform: " wavFile " [" m_onn "]"]
m_tit( m_tit == "_" ) = " ";
title(m_tit);

if(count>=5)
  plot([m_offs m_offs],[min(mono)*1.2 max(mono)*1.2],'marker','*','color',[0.5 0.7 0.5], ';Offset;');
  plot([m_cons m_cons], [min(mono) max(mono)],'marker','v','color',[0.9 0.5 0.5], ';Consenant;');
  plot([m_vowl m_vowl], [min(mono) max(mono)],'marker','^','color',[0.9 0.5 0.5], ';Cutoff;');
  plot([m_prev m_prev], [min(mono) max(mono)],'marker','+','color',[0.9 0.5 0.5], ';Preutter.;');
  plot([m_olap m_olap],[min(mono)/2 max(mono)/2],'marker','o','color',[0.9 0.5 0.5], ';Overlap;');
endif

hold ("off");

#subplot(2,1,2),plot(( 1:length(d)) / fs, d );

subplot(3,1,2);
hold ("on");
set (gca (), "xlim", [min_time, max_time]);
set (gca (), "ylim", [1.1*min(zcr_d), 1.1*max(zcr)]);
plot(timestamp , zcr, 'linewidth', 2);
title("Zero-Cross Rate");

plot(timestamp , zcr_d, "4" , 'linewidth', 2);
#title("Zero-Cross Rate Diff.");

plot([0 max(timestamp)],[0 0],'color',[0.5 0.5 0.5])

if(count>=5)
  plot([m_offs m_offs],[min(zcr_d) max(zcr)],'marker','*','color',[0.5 0.7 0.5]);
  plot([m_cons m_cons],[min(zcr_d) max(zcr)],'marker','v','color',[0.9 0.5 0.5]);
  plot([m_vowl m_vowl],[min(zcr_d) max(zcr)],'marker','^','color',[0.9 0.5 0.5]);
  plot([m_prev m_prev],[min(zcr_d) max(zcr)],'marker','+','color',[0.9 0.5 0.5]);
  plot([m_olap m_olap],[min(zcr_d)/2 max(zcr)/2],'marker','o','color',[0.9 0.5 0.5]);
endif

hold ("off");

subplot(3,1,3);
hold ("on");
set (gca (), "xlim", [min_time, max_time]);
set (gca (), "ylim", [1.1*min(var_d), 1.1*max(variance)]);
plot( timestamp , variance, 'linewidth', 2);
title("Spectrum Variance");

plot( timestamp , var_d, "4", 'linewidth', 2);
#title("Spectrum Variance Diff.");

plot([0 max(timestamp)],[0 0],'color',[0.5 0.5 0.5])

if(count>=5)
  plot([m_offs m_offs],[min(var_d) max(variance)],'marker','*','color',[0.5 0.7 0.5]);
  plot([m_cons m_cons],[min(var_d) max(variance)],'marker','v','color',[0.9 0.5 0.5]);
  plot([m_vowl m_vowl],[min(var_d) max(variance)],'marker','^','color',[0.9 0.5 0.5]);
  plot([m_prev m_prev],[min(var_d) max(variance)],'marker','+','color',[0.9 0.5 0.5]);
  plot([m_olap m_olap],[min(var_d)/2 max(variance)/2],'marker','o','color',[0.9 0.5 0.5]);
endif

hold ("off");

#subplot(6,1,6),plot( timestamp , pitch );
#title("Pitch Score");

pngFile=[arg_list{1} "_" m_onn ".png"];
print(pngFile,"-dpng");

subplot(1,1,1);

#input ("Press enter to continue");

endfor
